<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2012 Ethan Gruber
    xEAC: https://github.com/ewg118/xEAC
    Apache License 2.0
-->
<xhtml:html xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xeac="https://github.com/ewg118/xEAC"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xxi="http://orbeon.org/oxf/xml/xinclude" xmlns:eac="urn:isbn:1-931666-33-4" xmlns="urn:isbn:1-931666-33-4"
	xmlns:xxbl="http://orbeon.org/oxf/xml/xbl" xmlns:pipeline="java:org.orbeon.oxf.processor.pipeline.PipelineFunctionLibrary" xmlns:exf="http://www.exforms.org/exf/1-0"
	xmlns:saxon="http://saxon.sf.net/" xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
	xmlns:skos="http://www.w3.org/2004/02/skos/core#" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dbpedia-owl="http://dbpedia.org/ontology/" xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
	xmlns:dbpprop="http://dbpedia.org/property/"> 
	
	<xhtml:head>
		<xhtml:title>xEAC: Edit EAC-CPF Record</xhtml:title>
		<link rel="stylesheet" type="text/css" href="/apps/xeac/css/grids-min.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/xeac/css/reset-fonts-grids.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/xeac/css/base-min.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/xeac/css/fonts-min.css"/>
		<link rel="stylesheet" href="/apps/xeac/css/style.css"/>
		<link rel="stylesheet" href="/apps/xeac/css/themes/smoothness.css"/>
		<script type="text/javascript" src="/apps/xeac/javascript/jquery-1.4.2.min.js"/>
		<script type="text/javascript" src="/apps/xeac/javascript/menu.js"/>d <xforms:model>
			<xs:schema elementFormDefault="qualified" attributeFormDefault="unqualified">
				<xs:simpleType name="iso8601date">
					<xs:restriction base="xs:string">
						<xs:pattern
							value="(\-?(0|1|2)([0-9]{3})(((01|02|03|04|05|06|07|08|09|10|11|12)((0[1-9])|((1|2)[0-9])|(3[0-1])))|\-((01|02|03|04|05|06|07|08|09|10|11|12)(\-((0[1-9])|((1|2)[0-9])|(3[0-1])))?))?)"
						/>
					</xs:restriction>
				</xs:simpleType>
			</xs:schema>
			<!-- ******************* INSTANCES ****************** -->
			<xforms:instance id="doc">
				<eac-cpf xmlns="urn:isbn:1-931666-33-4" xmlns:xlink="http://www.w3.org/1999/xlink">
					<control>
						<recordId/>
						<maintenanceAgency>
							<agencyName/>
						</maintenanceAgency>
						<maintenanceHistory>
							<maintenanceEvent>
								<eventType>created</eventType>
								<eventDateTime standardDateTime=""/>
								<agentType>human</agentType>
								<agent/>
							</maintenanceEvent>
						</maintenanceHistory>
						<maintenanceStatus>new</maintenanceStatus>
					</control>
					<cpfDescription>
						<identity>
							<entityType/>
							<nameEntry>
								<part/>
							</nameEntry>
						</identity>
						<description/>
						<relations/>
					</cpfDescription>
				</eac-cpf>
			</xforms:instance>
			<xforms:instance id="eac-template">
				<eac-cpf xmlns="urn:isbn:1-931666-33-4" xmlns:owl="http://www.w3.org/2002/07/owl#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:xlink="http://www.w3.org/1999/xlink">
					<control>
						<recordId/>
						<maintenanceAgency>
							<agencyName/>
						</maintenanceAgency>
						<maintenanceHistory>
							<maintenanceEvent>
								<eventType>created</eventType>
								<eventDateTime standardDateTime=""/>
								<agentType>machine</agentType>
								<agent>xEAC</agent>
								<eventDescription>Record generated by xEAC cpfRelation.</eventDescription>
							</maintenanceEvent>
						</maintenanceHistory>
						<maintenanceStatus>new</maintenanceStatus>
					</control>
					<cpfDescription>
						<identity>
							<entityType/>
							<nameEntry>
								<part/>
							</nameEntry>
						</identity>
						<relations>
							<cpfRelation xlink:type="simple" xlink:href="" xlink:role="">
								<relationEntry/>
							</cpfRelation>
						</relations>
					</cpfDescription>
				</eac-cpf>
			</xforms:instance>
			<xforms:instance id="kml">
				<kml/>
			</xforms:instance>
			<xforms:instance id="control-instance">
				<control xmlns="">
					<pos/>
				</control>
			</xforms:instance>
			<xforms:instance id="status">
				<status xmlns=""/>
			</xforms:instance>
			<xforms:instance id="temp-id">
				<id xmlns="">
					<identifier/>
					<href/>
					<arcrole/>
					<relationEntry/>
				</id>
			</xforms:instance>
			<!-- exist URL is stored in an XML file -->
			<xforms:instance id="exist-url">
				<xi:include href="exist-url.xml"/>
			</xforms:instance>
			<xforms:instance id="config">
				<config xmlns=""/>
			</xforms:instance>
			<!-- VIAF instances -->
			<xforms:instance id="search-query">
				<query/>
			</xforms:instance>
			<xforms:instance id="viaf-response">
				<rss xmlns=""/>
			</xforms:instance>
			<xforms:instance id="viaf-id">
				<identifier/>
			</xforms:instance>
			<xforms:instance id="viaf-rdf">
				<rdf:RDF/>
			</xforms:instance>
			<xforms:instance id="viaf-authority-rdf">
				<rdf:RDF/>
			</xforms:instance>
			<!-- dbpedia instances -->
			<xforms:instance id="dbpedia-import">
				<control xmlns="">
					<names>true</names>
					<abstract>true</abstract>
					<relations>true</relations>
					<thumbnail>true</thumbnail>
				</control>
			</xforms:instance>
			<xforms:instance id="dbpedia-id">
				<identifier/>
			</xforms:instance>
			<xforms:instance id="dbpedia-rdf">
				<rdf:RDF/>
			</xforms:instance>
			<!--  *** controlled vocabulary lists *** -->
			<xforms:instance id="conventionDeclaration-list">
				<list xmlns=""/>
			</xforms:instance>
			<xforms:instance id="item-template">
				<item/>
			</xforms:instance>
			<xforms:instance id="maintenanceStatus-list">
				<list xmlns="">
					<item>cancelled</item>
					<item>deleted</item>
					<item>deletedReplaced</item>
					<item>deletedSplit</item>
					<item>derived</item>
					<item>new</item>
					<item>revised</item>
				</list>
			</xforms:instance>
			<xforms:instance id="eventType-list">
				<list xmlns="">
					<item>cancelled</item>
					<item>created</item>
					<item>deleted</item>
					<item>derived</item>
					<item>revised</item>
					<item>updated</item>
				</list>
			</xforms:instance>
			<xforms:instance id="agentType-list">
				<list xmlns="">
					<item>human</item>
					<item>machine</item>
				</list>
			</xforms:instance>
			<xforms:instance id="entityType-list">
				<list xmlns="">
					<item>corporateBody</item>
					<item>person</item>
					<item>family</item>
				</list>
			</xforms:instance>
			<!-- relations diff -->
			<xforms:instance id="relations-pre">
				<relations/>
			</xforms:instance>
			<xforms:instance id="relations-post">
				<relations/>
			</xforms:instance>
			<xforms:instance id="rel-template">
				<relation xlink:href="" xlink:arcrole=""/>
			</xforms:instance>
			<xforms:instance id="identifier">
				<identifer/>
			</xforms:instance>
			<xforms:instance id="action-list">
				<actions/>
			</xforms:instance>
			<xforms:instance id="action-template">
				<action source="" dest=""/>
			</xforms:instance>
			<xforms:instance id="action-add">
				<add type="" xlink:arcrole="" relationEntry=""/>
			</xforms:instance>
			<xforms:instance id="action-remove">
				<remove/>
			</xforms:instance>
			<xforms:instance id="action-change">
				<change xlink:arcrole=""/>
			</xforms:instance>
			<!-- temp instances -->
			<xforms:instance id="temp-doc">
				<eac-cpf xmlns="urn:isbn:1-931666-33-4"/>
			</xforms:instance>
			<!-- ******************* EAC ELEMENTS ****************** -->
			<!-- control -->
			<xforms:instance id="maintenanceEvent-template">
				<maintenanceEvent>
					<eventType/>
					<eventDateTime standardDateTime=""/>
					<agentType>human</agentType>
					<agent/>
				</maintenanceEvent>
			</xforms:instance>
			<xforms:instance id="conventionDeclaration-template">
				<conventionDeclaration>
					<abbreviation/>
					<citation/>
				</conventionDeclaration>
			</xforms:instance>
			<xforms:instance id="eventDescription-template">
				<eventDescription/>
			</xforms:instance>
			<xforms:instance id="otherRecordId-template">
				<otherRecordId/>
			</xforms:instance>
			<xforms:instance id="sources-template">
				<sources/>
			</xforms:instance>
			<xforms:instance id="source-template">
				<source xlink:type="simple" xlink:href=""/>
			</xforms:instance>
			<!-- cpfDescription -->
			<xforms:instance id="description-template">
				<description/>
			</xforms:instance>
			<xforms:instance id="relations-template">
				<relations/>
			</xforms:instance>
			<!-- identity -->
			<xforms:instance id="nameEntry-template">
				<nameEntry>
					<part/>
				</nameEntry>
			</xforms:instance>
			<xforms:instance id="part-template">
				<part/>
			</xforms:instance>
			<xforms:instance id="authorizedForm-template">
				<authorizedForm/>
			</xforms:instance>
			<xforms:instance id="alternativeForm-template">
				<alternativeForm/>
			</xforms:instance>
			<xforms:instance id="preferredForm-template">
				<preferredForm/>
			</xforms:instance>
			<xforms:instance id="nameEntryParallel-template">
				<nameEntryParallel/>
			</xforms:instance>
			<xforms:instance id="entityId-template">
				<entityId/>
			</xforms:instance>
			<xforms:instance id="descriptiveNote-template">
				<descriptiveNote>
					<p/>
				</descriptiveNote>
			</xforms:instance>
			<xforms:instance id="useDates-template">
				<useDates/>
			</xforms:instance>
			<!-- description -->
			<xforms:instance id="abstract-template">
				<abstract/>
			</xforms:instance>
			<xforms:instance id="biogHist-template">
				<biogHist/>
			</xforms:instance>
			<xforms:instance id="chronList-template">
				<chronList>
					<chronItem>
						<event/>
					</chronItem>
				</chronList>
			</xforms:instance>
			<xforms:instance id="citation-template">
				<citation/>
			</xforms:instance>
			<xforms:instance id="existDates-template">
				<existDates/>
			</xforms:instance>
			<xforms:instance id="function-template">
				<function>
					<term/>
				</function>
			</xforms:instance>
			<xforms:instance id="functions-template">
				<functions>
					<function>
						<term/>
					</function>
				</functions>
			</xforms:instance>
			<xforms:instance id="generalContext-template">
				<generalContext/>
			</xforms:instance>
			<xforms:instance id="languageUsed-template">
				<languageUsed>
					<language languageCode=""/>
					<script scriptCode=""/>
				</languageUsed>
			</xforms:instance>
			<xforms:instance id="languagesUsed-template">
				<languagesUsed>
					<languageUsed>
						<language languageCode=""/>
						<script scriptCode=""/>
					</languageUsed>
				</languagesUsed>
			</xforms:instance>
			<xforms:instance id="legalStatus-template">
				<legalStatus>
					<term/>
				</legalStatus>
			</xforms:instance>
			<xforms:instance id="legalStatuses-template">
				<legalStatuses>
					<legalStatus>
						<term/>
					</legalStatus>
				</legalStatuses>
			</xforms:instance>
			<xforms:instance id="list-template">
				<list>
					<item/>
				</list>
			</xforms:instance>
			<xforms:instance id="localDescription-template">
				<localDescription>
					<term/>
				</localDescription>
			</xforms:instance>
			<xforms:instance id="localDescriptions-template">
				<localDescriptions>
					<localDescription>
						<term/>
					</localDescription>
				</localDescriptions>
			</xforms:instance>
			<xforms:instance id="mandate-template">
				<mandate>
					<term/>
				</mandate>
			</xforms:instance>
			<xforms:instance id="mandates-template">
				<mandates>
					<mandate>
						<term/>
					</mandate>
				</mandates>
			</xforms:instance>
			<xforms:instance id="occupation-template">
				<occupation>
					<term/>
				</occupation>
			</xforms:instance>
			<xforms:instance id="occupations-template">
				<occupations>
					<occupation>
						<term/>
					</occupation>
				</occupations>
			</xforms:instance>
			<xforms:instance id="outline-template">
				<outline>
					<level>
						<item/>
					</level>
				</outline>
			</xforms:instance>
			<xforms:instance id="p-template">
				<p/>
			</xforms:instance>
			<xforms:instance id="place-template">
				<place>
					<placeEntry/>
				</place>
			</xforms:instance>
			<xforms:instance id="places-template">
				<places>
					<place>
						<term/>
					</place>
				</places>
			</xforms:instance>
			<xforms:instance id="structureOrGenealogy-template">
				<structureOrGenealogy/>
			</xforms:instance>
			<!-- relations -->
			<xforms:instance id="cpfRelation-template">
				<cpfRelation xlink:type="simple">
					<relationEntry/>
				</cpfRelation>
			</xforms:instance>
			<xforms:instance id="resourceRelation-template">
				<resourceRelation xlink:type="simple">
					<relationEntry/>
				</resourceRelation>
			</xforms:instance>
			<!-- ******************* SOLR INSTANCES ****************** -->
			<!-- send to Solr -->
			<xforms:instance id="addIndex">
				<add xmlns=""/>
			</xforms:instance>
			<!-- Instance for Solr commit-->
			<xforms:instance id="sendCommit">
				<commit/>
			</xforms:instance>
			<!-- ******************* BINDINGS ****************** -->
			<xforms:bind id="control-tab" nodeset="instance('doc')/eac:control"/>
			<xforms:bind id="identity-tab" nodeset="instance('doc')/eac:cpfDescription/eac:identity"/>
			<xforms:bind id="description-tab" nodeset="instance('doc')/eac:cpfDescription/eac:description"/>
			<xforms:bind id="relations-tab" nodeset="instance('doc')/eac:cpfDescription/eac:relations"/>
			<!-- DBpedia import bindings: checkboxes are xs:boolean -->
			<xforms:bind nodeset="instance('dbpedia-import')">
				<xforms:bind nodeset="*" type="xs:boolean"/>
			</xforms:bind>
			<!-- EAC-CPF bindings -->
			<xforms:bind nodeset="instance('doc')">
				<xforms:bind nodeset="eac:control">
					<xforms:bind nodeset="eac:recordId" required="true()"/>
					<xforms:bind nodeset="eac:maintenanceAgency/eac:agencyName" constraint="string-length(.) &gt; 0"/>
					<xforms:bind nodeset="eac:maintenanceStatus" constraint="string-length(.) &gt; 0"/>
					<xforms:bind nodeset="eac:maintenanceHistory">
						<xforms:bind nodeset="eac:maintenanceEvent">
							<xforms:bind nodeset="eac:eventType" required="true()"/>
							<xforms:bind nodeset="eac:eventDateTime">
								<xforms:bind nodeset="@standardDateTime" type="xs:dateTime" required="true()"/>
							</xforms:bind>
							<xforms:bind nodeset="eac:agentType" required="true()"/>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="eac:conventionDeclaration">
						<!-- only allow editing of abbreviation and citation if they are unused by nameEntry -->
						<xforms:bind nodeset="eac:abbreviation" required="true()" readonly="string-length(.) &gt; 0 and instance('doc')//eac:nameEntry/*[contains(local-name(), 'Form')] = ."/>
						<xforms:bind nodeset="eac:citation" required="true()"
							readonly="string-length(parent::node()/eac:abbreviation) &gt; 0 and instance('doc')//eac:nameEntry/*[contains(local-name(), 'Form')] = parent::node()/eac:abbreviation"/>
					</xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="eac:cpfDescription">
					<!-- set content for dates anywhere -->
					<xforms:bind nodeset="descendant::*/@standardDate" type="iso8601date" required="true()"/>
					<xforms:bind nodeset="eac:identity">
						<xforms:bind nodeset="eac:entityType" required="true()"/>
						<xforms:bind nodeset="eac:nameEntry">
							<xforms:bind nodeset="eac:part" required="true()"/>
							<xforms:bind nodeset="eac:alternativeForm" required="true()"/>
							<xforms:bind nodeset="eac:authorizedForm" required="true()"/>
							<xforms:bind nodeset="eac:preferredForm" required="true()"/>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="eac:description">
						<xforms:bind nodeset="eac:biogHist">
							<xforms:bind nodeset="eac:chronList">
								<xforms:bind nodeset="eac:chronItem" constraint="count(eac:date) &gt; 0 or count(eac:dateRange) &gt; 0"/>
							</xforms:bind>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="eac:relations">
						<xforms:bind nodeset="descendant::eac:relationEntry" required="true()"/>
					</xforms:bind>
				</xforms:bind>
			</xforms:bind>
			<!-- ******************* SUBMISSIONS ****************** -->
			<!-- load preliminary instances -->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-url')}xeac/config.xml" replace="instance" instance="config" xxforms:username="admin"
				xxforms:password=""/>
			<!-- Submission to get the document -->
			<xforms:submission id="load-doc" serialization="none" method="get" action="{instance('exist-url')}xeac/records/{instance('doc')/eac:control/eac:recordId}.xml" replace="instance"
				instance="doc" xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load EAC record</xforms:message>
			</xforms:submission>
			<xforms:submission id="load-temp-doc" serialization="none" method="get" action="{instance('exist-url')}xeac/records/{instance('temp-id')/identifier}.xml" replace="instance"
				instance="temp-doc" xxforms:username="admin" xxforms:password="">
				<!-- only initiate the following functions for an 'add' -->
				<!-- load document to create cpfRelation, if it exists -->
				<xforms:action ev:event="xforms-submit-done">
					<!-- process addition -->
					<xforms:action if="instance('action-list')//*[local-name()='add']/parent::node()[@dest=instance('temp-id')/identifier]">
						<!-- insert maintenanceEvent, set values -->
						<xforms:insert context="instance('temp-doc')/eac:control/eac:maintenanceHistory" nodeset="./child::node()[last()]" origin="instance('maintenanceEvent-template')"/>
						<xforms:insert context="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]" nodeset="./child::node()[last()]"
							origin="instance('eventDescription-template')"/>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventType">revised</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:agentType">machine</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:agent">xEAC</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDescription">Relation Inserted</xforms:setvalue>
						<xforms:insert context="instance('temp-doc')/eac:cpfDescription/eac:relations" nodeset="./child::node()[last()]" origin="instance('cpfRelation-template')"/>
						<!-- insert xlink attributes -->
						<xforms:insert context="instance('temp-doc')/eac:cpfDescription/eac:relations/eac:cpfRelation[last()]" origin="xxforms:attribute('xlink:href', instance('temp-id')/href)"/>
						<xforms:insert context="instance('temp-doc')/eac:cpfDescription/eac:relations/eac:cpfRelation[last()]" origin="xxforms:attribute('xlink:arcrole', instance('temp-id')/arcrole)"/>
						<xforms:setvalue ref="instance('temp-doc')/eac:cpfDescription/eac:relations/eac:cpfRelation[last()]/eac:relationEntry" value="instance('temp-id')/relationEntry"/>
						<xforms:send submission="save-temp-doc"/>
					</xforms:action>
					<!-- process removal -->
					<xforms:action if="instance('action-list')//*[local-name()='remove']/parent::node()[@dest=instance('temp-id')/identifier]">
						<!-- insert maintenanceEvent, set values -->
						<xforms:insert context="instance('temp-doc')/eac:control/eac:maintenanceHistory" nodeset="./child::node()[last()]" origin="instance('maintenanceEvent-template')"/>
						<xforms:insert context="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]" nodeset="./child::node()[last()]"
							origin="instance('eventDescription-template')"/>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventType">revised</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:agentType">machine</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:agent">xEAC</xforms:setvalue>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
						<xforms:setvalue ref="instance('temp-doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDescription">Relation Deleted</xforms:setvalue>
						<!-- delete eac:cpfRelation -->
						<xforms:delete nodeset="instance('temp-doc')/eac:cpfDescription/eac:relations/eac:cpfRelation[@xlink:href=instance('temp-id')/href]"/>
						<xforms:send submission="save-temp-doc"/>
					</xforms:action>
				</xforms:action>
				<!-- If temp-doc does not exist, create new EAC-CPF record from eac-template -->
				<xforms:action ev:event="xforms-submit-error">
					<xxforms:variable name="id" select="instance('temp-id')/identifier"/>
					<xxforms:variable name="role" select="instance('doc')//eac:cpfRelation[@xlink:href=$id]/@xlink:role"/>
					<!-- set template metadata -->
					<xforms:setvalue ref="instance('eac-template')/eac:control/eac:recordId" value="$id"/>
					<xforms:setvalue ref="instance('eac-template')/eac:control/eac:maintenanceAgency/eac:agencyName" value="instance('doc')/eac:control/eac:maintenanceAgency/eac:agencyName"/>
					<xforms:setvalue ref="instance('eac-template')/eac:cpfDescription/eac:identity/eac:nameEntry/eac:part" value="instance('doc')//eac:cpfRelation[@xlink:href=$id]/eac:relationEntry"/>
					<xforms:setvalue ref="instance('eac-template')/eac:cpfDescription/eac:identity/eac:entityType"
						value="if ($role='http://RDVocab.info/uri/schema/FRBRentitiesRDA/Person') then 'person' else 'corporateBody'"/>
					<!-- set cpfRelation with current doc info -->
					<xxforms:variable name="entityType" select="instance('doc')/eac:cpfDescription/eac:identity/eac:entityType"/>
					<xforms:setvalue ref="instance('eac-template')/eac:cpfDescription/eac:relations/eac:cpfRelation/eac:relationEntry"
						value="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[1]/eac:part"/>
					<xforms:setvalue ref="instance('eac-template')/eac:cpfDescription/eac:relations/eac:cpfRelation/@xlink:href" value="instance('doc')/eac:control/eac:recordId"/>
					<xforms:setvalue ref="instance('eac-template')/eac:cpfDescription/eac:relations/eac:cpfRelation/@xlink:role"
						value="if ($entityType = 'person') then 'http://RDVocab.info/uri/schema/FRBRentitiesRDA/Person' else 'http://RDVocab.info/uri/schema/FRBRentitiesRDA/CorporateBody'"/>
					<!-- set xlink:arcrole if it has been set -->
					<xforms:insert context="instance('eac-template')/eac:cpfDescription/eac:relations/eac:cpfRelation"
						origin="xxforms:attribute('xlink:arcrole', instance('doc')//eac:cpfRelation[@xlink:href=$id]/@xlink:arcrole)"
						if="string-length(instance('doc')//eac:cpfRelation[@xlink:href=$id]/@xlink:arcrole) &gt; 0"/>
					<!-- set current dateTime -->
					<xforms:setvalue ref="instance('eac-template')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
					<!-- save template -->
					<xforms:send submission="save-eac-template"/>
				</xforms:action>
			</xforms:submission>
			<!-- Submission to save the document -->
			<xforms:submission id="save-doc" ref="instance('doc')" action="{instance('exist-url')}xeac/records/{instance('doc')/eac:control/eac:recordId}.xml" method="put" replace="none"
				xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Documents. Be sure all required inputs are filled in.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('status')">EAC record saved.</xforms:setvalue>
					<!-- update dateTime of last maintenanceEvent -->
					<xforms:setvalue ref="instance('doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
					<!-- post to Solr unpublished core -->
					<xforms:insert nodeset="instance('addIndex')" origin="xxforms:call-xpl('oxf:/apps/xeac/xpl/eac-to-solr-all.xpl', 'data', instance('doc'), 'data')"/>
					<xforms:send submission="post-to-all"/>
					<!-- generate KML -->
					<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/xeac/xpl/eac-to-kml.xpl', 'data', instance('doc'), 'data')"/>
					<xforms:send submission="save-kml"/>
					<!-- *************** PROCESS RELATIONS **************** -->
					<!-- generate post-edit list on Save -->
					<xforms:action xxforms:iterate="instance('doc')/eac:cpfDescription/eac:relations/eac:cpfRelation">
						<xforms:insert context="instance('relations-post')" nodeset="./child::node()[last()]" origin="instance('rel-template')"/>
						<xforms:setvalue ref="instance('relations-post')/eac:relation[last()]/@xlink:href" value="context()/@xlink:href"/>
						<xforms:setvalue ref="instance('relations-post')/eac:relation[last()]/@xlink:arcrole" value="context()/@xlink:arcrole"/>
					</xforms:action>
					<!-- ***** GENERATE ACTION LIST ***** -->
					<xforms:action xxforms:iterate="instance('relations-post')/eac:relation[@xlink:href]">
						<!-- create new relations -->
						<xxforms:variable name="href" select="@xlink:href"/>
						<xforms:action if="not(instance('relations-pre')/eac:relation[@xlink:href=$href])">
							<xforms:insert context="instance('action-list')" nodeset="./child::node()[last()]" origin="instance('action-template')"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/@source" value="instance('doc')/eac:control/eac:recordId"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/@dest" value="context()/@xlink:href"/>
							<!-- insert add action -->
							<xforms:insert context="instance('action-list')/eac:action[last()]" origin="instance('action-add')"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/eac:add/@xlink:arcrole" value="context()/@xlink:arcrole"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/eac:add/@relationEntry" value="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry/eac:part"/>
						</xforms:action>
						<!-- create changes by comparing pre and post relations with matching xlink:hrefs -->
					</xforms:action>
					<!-- add removals to action list: cpfRelations with xlink:hrefs that do not appear in post -->
					<xforms:action xxforms:iterate="instance('relations-pre')/eac:relation[@xlink:href]">
						<!-- create new relations -->
						<xxforms:variable name="href" select="@xlink:href"/>
						<xforms:action if="not(instance('relations-post')/eac:relation[@xlink:href=$href])">
							<xforms:insert context="instance('action-list')" nodeset="./child::node()[last()]" origin="instance('action-template')"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/@source" value="instance('doc')/eac:control/eac:recordId"/>
							<xforms:setvalue ref="instance('action-list')/eac:action[last()]/@dest" value="context()/@xlink:href"/>
							<!-- insert remove action -->
							<xforms:insert context="instance('action-list')/eac:action[last()]" origin="instance('action-remove')"/>
						</xforms:action>
					</xforms:action>
					<!-- ***** PROCESS ACTION LIST ***** -->
					<!-- iterate through additions -->
					<xforms:action xxforms:iterate="instance('action-list')/eac:action[eac:add]">
						<xforms:setvalue ref="instance('temp-id')/identifier" value="context()/@dest"/>
						<xforms:setvalue ref="instance('temp-id')/href" value="context()/@source"/>
						<xforms:setvalue ref="instance('temp-id')/arcrole" value="context()/eac:add/@xlink:arcrole"/>
						<xforms:setvalue ref="instance('temp-id')/relationEntry" value="context()/eac:add/@relationEntry"/>
						<xforms:send submission="load-temp-doc"/>
					</xforms:action>
					<!-- iterate through removals -->
					<xforms:action xxforms:iterate="instance('action-list')/eac:action[eac:remove]">
						<xforms:setvalue ref="instance('temp-id')/identifier" value="context()/@dest"/>
						<xforms:setvalue ref="instance('temp-id')/href" value="context()/@source"/>
						<xforms:send submission="load-temp-doc"/>
					</xforms:action>
					<!-- reprocess pre list -->
					<xforms:delete nodeset="instance('relations-pre')/*"/>
					<xforms:action xxforms:iterate="instance('doc')/eac:cpfDescription/eac:relations/eac:cpfRelation">
						<xforms:setvalue ref="instance('rel-template')/@xlink:href" value="context()/@xlink:href"/>
						<xforms:setvalue ref="instance('rel-template')/@xlink:arcrole" value="context()/@xlink:arcrole"/>
						<xforms:insert context="instance('relations-pre')" nodeset="./child::node()[last()]" origin="instance('rel-template')"/>
					</xforms:action>
					<!-- remove relations from post-list -->
					<xforms:delete nodeset="instance('relations-post')/*"/>
					<xforms:delete nodeset="instance('action-list')/*"/>
					<!-- check to see if the document is already published to Solr -->
					<!--<xforms:send submission="query-solr-for-publication"/>-->
				</xforms:action>
			</xforms:submission>
			<xforms:submission id="save-kml" ref="instance('kml')" action="{instance('exist-url')}xeac/kml/{instance('doc')/eac:control/eac:recordId}.kml" method="put" replace="none"
				xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving KML.</xforms:message>
			</xforms:submission>
			<xforms:submission id="save-temp-doc" ref="instance('temp-doc')" action="{instance('exist-url')}xeac/records/{instance('temp-doc')/eac:control/eac:recordId}.xml" method="put"
				replace="none" xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Documents. Be sure all required inputs are filled in.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('status')">EAC record saved.</xforms:setvalue>
					<!-- post to Solr unpublished core -->
					<xforms:insert nodeset="instance('addIndex')" origin="xxforms:call-xpl('oxf:/apps/xeac/xpl/eac-to-solr-all.xpl', 'data', instance('temp-doc'), 'data')"/>
					<xforms:send submission="post-to-all"/>
				</xforms:action>
			</xforms:submission>
			<xforms:submission id="save-eac-template" ref="instance('eac-template')" action="{instance('exist-url')}xeac/records/{instance('eac-template')/eac:control/eac:recordId}.xml" method="put"
				replace="none" xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error Saving Documents. Be sure all required inputs are filled in.</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('status')">EAC record saved.</xforms:setvalue>
					<!-- post to Solr unpublished core -->
					<xforms:insert nodeset="instance('addIndex')" origin="xxforms:call-xpl('oxf:/apps/xeac/xpl/eac-to-solr-all.xpl', 'data', instance('eac-template'), 'data')"/>
					<xforms:send submission="post-to-all"/>
				</xforms:action>
			</xforms:submission>
			<!-- submission to query solr to see if the document is published -->
			<xforms:submission id="query-solr-for-publication" serialization="none" method="get" action="{instance('config')/solr_published}select/?q=id:{instance('doc')/eac:control/eac:recordId}"
				replace="instance" instance="is-published">
				<!-- if the document is found in solr, get the updated solr doc -->
				<xforms:send ev:event="xforms-submit-done" if="instance('is-published')/result[@name='response']/@numFound = '1'" submission="ead-publish"/>
			</xforms:submission>
			<!-- access service to read in pre-transformed solr doc -->
			<xforms:submission id="eac-publish" method="get" replace="instance" instance="addIndex" serialization="none" resource="/xeac/solr/{instance('doc')/eac:control/eac:recordId}">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error transforming EAC record to Solr document.</xforms:message>
				<xforms:send ev:event="xforms-submit-done" submission="publish-submission"/>
			</xforms:submission>
			<!-- post instance to Solr -->
			<xforms:submission id="publish-submission" action="{instance('config')/solr_published}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:send ev:event="xforms-submit-done" submission="submit-commit"/>
				<xforms:setvalue ev:event="xforms-submit-done" ref="instance('status')">EAC record saved and updated to search index.</xforms:setvalue>
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
			</xforms:submission>
			<!-- send commit -->
			<xforms:submission id="submit-commit" action="{instance('config')/solr_published}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post"/>
			<!-- for unpublished documents, always save to unpublished core -->
			<!-- post instance to Solr -->
			<xforms:submission id="post-to-all" action="{instance('config')/solr_all}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:send ev:event="xforms-submit-done" submission="submit-all-commit"/>
				<xforms:setvalue ev:event="xforms-submit-done" ref="instance('status')">EAC record saved.</xforms:setvalue>
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
			</xforms:submission>
			<!-- send commit -->
			<xforms:submission id="submit-all-commit" action="{instance('config')/solr_all}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post"/>
			<!-- ***************** QUERY VIAF *****************-->
			<xforms:submission id="query-viaf" serialization="none" method="get"
				action="http://viaf.org/viaf/search?query=local.names+all+%22{instance('search-query')}%22&amp;sortKeys=holdingscount&amp;maximumRecords=50&amp;httpAccept=application/rss%2bxml"
				instance="viaf-response" replace="instance">
				<xforms:message ev:event="xforms-submit-error" level="modal">Error querying VIAF.</xforms:message>
			</xforms:submission>
			<xforms:submission id="get-viaf-rdf" serialization="none" method="get" action="{instance('viaf-id')}/rdf.xml" instance="viaf-rdf" replace="instance">
				<xforms:action ev:event="xforms-submit-done">
					<!-- insert otherRecordId -->
					<xforms:insert context="instance('doc')/eac:control" nodeset="eac:recordId" position="after" origin="instance('otherRecordId-template')"/>
					<xforms:insert context="instance('doc')/eac:control/eac:otherRecordId[1]" origin="xxforms:attribute('localType', 'VIAFId')"/>
					<xforms:setvalue ref="instance('doc')/eac:control/eac:otherRecordId[1]" value="instance('viaf-id')"/>
					<!-- insert source for VIAF URI -->
					<xforms:insert context="instance('doc')/eac:control" nodeset="./child::node()[last()]" origin="instance('sources-template')" if="count(instance('doc')/eac:control/eac:sources) = 0"/>
					<xforms:insert context="instance('doc')/eac:control/eac:sources" nodeset="./child::node()[last()]" origin="instance('source-template')"/>
					<xforms:setvalue ref="instance('doc')/eac:control/eac:sources/eac:source[last()]/@xlink:href" value="instance('viaf-id')"/>
					<!-- create nameEntries -->
					<xforms:action xxforms:iterate="instance('viaf-rdf')//skos:Concept">
						<xxforms:variable name="auth" select="substring-after(context()/skos:inScheme/@rdf:resource, 'authorityScheme/')"/>
						<xforms:setvalue ref="instance('viaf-id')" value="context()/skos:inScheme/@rdf:resource"/>
						<!-- insert conventionDeclarations into control -->
						<xforms:insert context="instance('doc')/eac:control" nodeset="./child::node()[last()]" origin="instance('conventionDeclaration-template')"/>
						<!--<xforms:insert context="instance('doc')/eac:control/eac:conventionDeclaration[last()]" nodeset="./child::node()[last()]" origin="instance('descriptiveNote-template')"/>-->
						<xforms:setvalue ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:abbreviation" value="$auth"/>
						<!--<xforms:setvalue ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:descriptiveNote/eac:p" value="context()/skos:inScheme/@rdf:resource"/>-->
						<!-- set the citation with the dcterms:title from VIAF, if it exists, otherwise the URI for the authorityScheme -->
						<xforms:send submission="get-viaf-authority-rdf"/>
						<!-- insert preferred forms per authority -->
						<xforms:action xxforms:iterate="context()/skos:prefLabel">
							<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity" nodeset="./child::node()[last()]" origin="instance('nameEntry-template')"/>
							<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:part" value="context()"/>
							<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]" nodeset="./child::node()[last()]" origin="instance('preferredForm-template')"/>
							<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:preferredForm" value="$auth"/>
						</xforms:action>
						<xforms:action xxforms:iterate="context()/skos:altLabel">
							<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity" nodeset="./child::node()[last()]" origin="instance('nameEntry-template')"/>
							<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:part" value="context()"/>
							<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]" nodeset="./child::node()[last()]"
								origin="instance('alternativeForm-template')"/>
							<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:alternativeForm" value="$auth"/>
						</xforms:action>
					</xforms:action>
				</xforms:action>
			</xforms:submission>
			<xforms:submission id="get-viaf-authority-rdf" serialization="none" method="get" action="{instance('viaf-id')}/rdf.xml" instance="viaf-authority-rdf" replace="instance">
				<xforms:setvalue ev:event="xforms-submit-error" ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:citation" value="instance('viaf-id')"/>
				<xforms:setvalue ev:event="xforms-submit-done" ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:citation" value="instance('viaf-authority-rdf')//dcterms:title"/>
			</xforms:submission>
			<!-- ***************** QUERY DBPEDIA *****************-->
			<xforms:submission id="get-dbpedia-rdf" serialization="none" method="get" action="http://dbpedia.org/data/{substring-after(instance('dbpedia-id'), 'resource/')}.rdf" instance="dbpedia-rdf"
				replace="instance">
				<xforms:action ev:event="xforms-submit-done">
					<xforms:action if="count(instance('dbpedia-rdf')/rdf:Description) &gt; 0">
						<!--insert otherRecordId -->
						<xforms:insert context="instance('doc')/eac:control" nodeset="eac:recordId" position="after" origin="instance('otherRecordId-template')"/>
						<xforms:setvalue ref="instance('doc')/eac:control/eac:otherRecordId[1]" value="instance('dbpedia-rdf')/rdf:Description[1]/@rdf:about"/>
						<!-- insert source for dbpedia URI -->
						<xforms:insert context="instance('doc')/eac:control" nodeset="./child::node()[last()]" origin="instance('sources-template')"
							if="count(instance('doc')/eac:control/eac:sources) = 0"/>
						<xforms:insert context="instance('doc')/eac:control/eac:sources" nodeset="./child::node()[last()]" origin="instance('source-template')"/>
						<xforms:setvalue ref="instance('doc')/eac:control/eac:sources/eac:source[last()]/@xlink:href" value="instance('dbpedia-rdf')/rdf:Description[1]/@rdf:about"/>
					</xforms:action>
					<xforms:action if="count(instance('dbpedia-rdf')/rdf:Description) = 0">
						<xforms:message level="modal">DBpedia resource does not exist.</xforms:message>
					</xforms:action>
				</xforms:action>
			</xforms:submission>
			<!-- ************************ xforms-model-construct-done ****************************** -->
			<!-- load recordId -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:send submission="load-config"/>
				<!-- if there is a recordId parameter, load existing EAC record -->
				<xforms:action if="string(xxforms:get-request-parameter('recordId'))">
					<xforms:setvalue ref="instance('doc')/eac:control/eac:recordId" value="xxforms:get-request-parameter('recordId')"/>
					<xforms:send submission="load-doc"/>
					<xforms:action ev:event="xforms-submit-done">
						<!-- create relations list for diff -->
						<xforms:action xxforms:iterate="instance('doc')/eac:cpfDescription/eac:relations/eac:cpfRelation">
							<xforms:setvalue ref="instance('rel-template')/@xlink:href" value="context()/@xlink:href"/>
							<xforms:setvalue ref="instance('rel-template')/@xlink:arcrole" value="context()/@xlink:arcrole"/>
							<xforms:insert context="instance('relations-pre')" nodeset="./child::node()[last()]" origin="instance('rel-template')"/>
						</xforms:action>
						<!-- insert maintenanceEvent, set values -->
						<xforms:insert context="instance('doc')/eac:control/eac:maintenanceHistory" nodeset="./child::node()[last()]" origin="instance('maintenanceEvent-template')"/>
						<xforms:setvalue ref="instance('doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventType">revised</xforms:setvalue>
						<xforms:setvalue ref="instance('doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent[last()]/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
						<!-- set conventionDeclaration-list for nameEntry forms -->
						<!--<xforms:action xxforms:iterate="instance('doc')/eac:control/eac:conventionDeclaration">
							<xforms:insert context="instance('conventionDeclaration-list')" nodeset="./child::node()[last()]" origin="instance('item-template')"/>
							<xforms:setvalue ref="instance('conventionDeclaration-list')"/>
						</xforms:action>-->
					</xforms:action>
				</xforms:action>
				<xforms:action if="not(string(xxforms:get-request-parameter('recordId')))">
					<!-- set current dateTime and boilerplate information on creation of new record -->
					<xforms:setvalue ref="instance('doc')/eac:control/eac:maintenanceHistory/eac:maintenanceEvent/eac:eventDateTime/@standardDateTime" value="current-dateTime()"/>
					<xforms:setvalue ref="instance('doc')/eac:control/eac:maintenanceAgency/eac:agencyName" value="instance('config')/instances/agencyName-list/item[@default='true']"/>
					<!--<xforms:send submission="load-eac-template"/>-->
				</xforms:action>
			</xforms:action>
			<!--<xforms:action ev:event="xforms-ready">
				<xforms:dispatch targetid="temp-tab" name="fr-toggle"/>
			</xforms:action>-->
		</xforms:model>
		<!-- XBL components -->
		<xi:include href="oxf:/xbl/xeac/chronList/chronList.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/citation/citation.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/cpfRelation/cpfRelation.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/datesContainer/datesContainer.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/date/date.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/dateRange/dateRange.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/dateSet/dateSet.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/descriptionTerm/descriptionTerm.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/descriptionTermGroup/descriptionTermGroup.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/descriptiveNote/descriptiveNote.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/languageUsed/languageUsed.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/level/level.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/list/list.xbl" xi:omit-xml-base="true"/>
		<!--<xi:include href="oxf:/xbl/xeac/nameEntry/nameEntry.xbl" xi:omit-xml-base="true"/>-->
		<xi:include href="oxf:/xbl/xeac/outline/outline.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/p/p.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/place/place.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/placeEntry/placeEntry.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/relation/relation.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/relationEntry/relationEntry.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/reorder/reorder.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/resourceRelation/resourceRelation.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/xeac/structureOrGenealogy/structureOrGenealogy.xbl" xi:omit-xml-base="true"/>
	</xhtml:head>
	<xhtml:body class="yui-skin-sam">
		<div id="doc4" class="yui-t2">
			<!-- header -->
			<xxforms:variable name="display_path">../../</xxforms:variable>
			<!--<xi:include href="header-admin.xml"/>-->
			<div id="bd">
				<xforms:group ref="instance('status')/text()">
					<div class="success">
						<xforms:output ref="instance('status')"/>
					</div>
				</xforms:group>
				<p>
					<a href="../">&lt; Return</a>
				</p>
				<div id="yui-main">
					<div id="form">
						<div class="submission">
							<xforms:trigger appearance="minimal">
								<xforms:label><img src="{$display_path}images/save.gif" alt="Save"/>Save</xforms:label>
								<xforms:action ev:event="DOMActivate">
									<xforms:send submission="save-doc"/>
								</xforms:action>
							</xforms:trigger>
							<xforms:submit submission="load-doc" appearance="minimal">
								<xforms:label><img src="{$display_path}images/recycle-green.png" alt="Revert"/>Load</xforms:label>
							</xforms:submit>
						</div>
						<!--<xforms:trigger>
							<xforms:label>Test</xforms:label>
							<xforms:action ev:event="DOMActivate">
								<xxforms:variable name="temp1" select="xxforms:serialize(instance('temp1'), 'text')"/>
								<xxforms:variable name="temp2" select="instance('temp2')"/>
								
								<xforms:message level="modal">
									<xforms:output value="$temp1"/>
								</xforms:message>
							</xforms:action>
						</xforms:trigger>-->
						<div class="section">
							<h1>Edit EAC-CPF Record</h1>
							<span class="add">
								<xforms:trigger appearance="minimal">
									<xforms:label>
										<xhtml:img src="{$display_path}images/add.gif"/>Import VIAF Data</xforms:label>
									<xxforms:show ev:event="DOMActivate" dialog="import-viaf-dialog"/>
								</xforms:trigger>
							</span>
							<span class="add">
								<xforms:trigger appearance="minimal">
									<xforms:label>
										<xhtml:img src="{$display_path}images/add.gif"/>Import DBpedia Data</xforms:label>
									<xxforms:show ev:event="DOMActivate" dialog="import-dbpedia-dialog"/>
								</xforms:trigger>
							</span>
							<div class="trigger_container">
								<xforms:group ref="instance('doc')[count(eac:cpfDescription/eac:description) = 0]">
									<xforms:trigger appearance="minimal">
										<xforms:label>
											<img src="{$display_path}images/add.gif"/>Description</xforms:label>
										<xforms:insert ev:event="DOMActivate" context="instance('doc')/eac:cpfDescription" origin="instance('description-template')" nodeset="eac:identity"
											position="after"/>
									</xforms:trigger>
								</xforms:group>
								<xforms:group ref="instance('doc')[count(eac:cpfDescription/eac:relations) = 0]">
									<xforms:trigger appearance="minimal">
										<xforms:label>
											<img src="{$display_path}images/add.gif"/>Relations</xforms:label>
										<xforms:insert ev:event="DOMActivate" context="instance('doc')/eac:cpfDescription" origin="instance('relations-template')" nodeset="./child::node()[last()]"/>
									</xforms:trigger>
								</xforms:group>
							</div>
							<div>
								<xforms:input ref="instance('doc')/eac:control/eac:recordId">
									<xforms:label>Record ID</xforms:label>
									<xforms:alert>The id is required</xforms:alert>
								</xforms:input>
							</div>
						</div>
						<fr:tabview>
							<!--**************************************** IDENTITY **********************************-->
							<fr:tab bind="identity-tab" id="default-tab">
								<fr:label>Identity</fr:label>
								<div class="section">
									<h1>Identity</h1>
									<div class="trigger_container">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Name Entry</xforms:label>
											<xforms:insert ev:event="DOMActivate" context="." origin="instance('nameEntry-template')"
												nodeset="if (count(eac:nameEntry) &gt; 0) then eac:nameEntry[last()] else eac:entityType" position="after"/>
										</xforms:trigger>
										<xforms:group ref=".[count(eac:entityId) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>Entity Id</xforms:label>
												<xforms:insert ev:event="DOMActivate" context="." origin="instance('entityId-template')" nodeset="./child::node()[last()]"/>
											</xforms:trigger>
										</xforms:group>
										<xforms:group ref=".[count(eac:descriptiveNote) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>Descriptive Note</xforms:label>
												<xforms:insert ev:event="DOMActivate" context="." origin="instance('descriptiveNote-template')" nodeset="./child::node()[last()]"/>
											</xforms:trigger>
										</xforms:group>
									</div>
									<div>
										<xforms:select1 ref="eac:entityType">
											<xforms:label>Entity Type</xforms:label>
											<xforms:alert>Required</xforms:alert>
											<xforms:item>
												<xforms:label>Select...</xforms:label>
												<xforms:value/>
											</xforms:item>
											<xforms:itemset nodeset="instance('entityType-list')/item">
												<xforms:label ref="."/>
												<xforms:value ref="."/>
											</xforms:itemset>
										</xforms:select1>
									</div>
									<xforms:repeat nodeset="eac:nameEntry">
										<div class="subsection">
											<h3>Name Entry</h3>
											<!--<xforms:trigger appearance="minimal">
												<xforms:label>(set as default)</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert origin="$binding" context="parent::node()"/>
													<xforms:delete nodeset="."/>
												</xforms:action>
												</xforms:trigger>-->
											<xforms:group ref=".[count(parent::node()/eac:nameEntry) &gt; 1 or count(parent::node()/eac:nameEntryParallel) &gt; 1]">
												<xforms:trigger appearance="minimal">
													<xforms:delete ev:event="DOMActivate" nodeset="."/>
													<xforms:label>
														<xhtml:img src="{$display_path}images/remove.gif"/>
													</xforms:label>
												</xforms:trigger>
											</xforms:group>
											<div class="trigger_container">
												<!-- must add part -->
												<xforms:group ref=".[not(parent::eac:nameEntryParallel)]">
													<xforms:group ref=".[count(eac:authorizedForm) = 0]">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<img src="{$display_path}images/add.gif"/>Authorized Form</xforms:label>
															<xforms:action ev:event="DOMActivate">
																<xforms:insert context="." origin="instance('authorizedForm-template')" nodeset="./child::node()[last()]"/>
																<xxforms:hide dialog="nameEntry-objects"/>
															</xforms:action>
														</xforms:trigger>
													</xforms:group>
													<xforms:group ref=".[count(eac:alternativeForm) = 0]">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<img src="{$display_path}images/add.gif"/>Alternative Form</xforms:label>
															<xforms:action ev:event="DOMActivate">
																<xforms:insert context="." origin="instance('alternativeForm-template')" nodeset="./child::node()[last()]"/>
																<xxforms:hide dialog="nameEntry-objects"/>
															</xforms:action>
														</xforms:trigger>
													</xforms:group>
												</xforms:group>
												<xforms:group ref=".[count(eac:preferredForm) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Preferred Form</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('preferredForm-template')" nodeset="./child::node()[last()]"/>
															<xxforms:hide dialog="nameEntry-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(eac:useDates) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Use Dates</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('useDates-template')" nodeset="./child::node()[last()]"/>
															<xxforms:hide dialog="nameEntry-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
											</div>
											<xforms:repeat nodeset="eac:part">
												<div>
													<xforms:input ref=".">
														<xforms:label>Part</xforms:label>
														<xforms:alert>Required</xforms:alert>
													</xforms:input>
													<xforms:group ref=".[count(parent::eac:nameEntry/eac:part) &gt; 1]">
														<xforms:trigger appearance="minimal">
															<xforms:delete ev:event="DOMActivate" nodeset="."/>
															<xforms:label>
																<xhtml:img src="{$display_path}images/remove.gif"/>
															</xforms:label>
														</xforms:trigger>
													</xforms:group>
												</div>
											</xforms:repeat>
											<xforms:group ref="eac:authorizedForm|eac:preferredForm|eac:alternativeForm">
												<div>
													<xforms:select1 ref=".">
														<xforms:label>
															<xforms:output
																ref="concat(upper-case(substring(substring-before(local-name(), 'Form'), 1, 1)), substring(substring-before(local-name(), 'Form'), 2), ' Form')"
															/>
														</xforms:label>
														<xforms:alert>Required</xforms:alert>
														<xforms:item>
															<xforms:label>Select...</xforms:label>
															<xforms:value/>
														</xforms:item>
														<xforms:itemset nodeset="instance('doc')//eac:conventionDeclaration[string(eac:abbreviation)]">
															<xforms:label ref="eac:citation"/>
															<xforms:value ref="eac:abbreviation"/>
														</xforms:itemset>
													</xforms:select1>
													<xforms:trigger appearance="minimal">
														<xforms:delete ev:event="DOMActivate" nodeset="."/>
														<xforms:label>
															<xhtml:img src="{$display_path}images/remove.gif"/>
														</xforms:label>
													</xforms:trigger>
												</div>
											</xforms:group>
											<xforms:group ref="eac:useDates">
												<xeac:datesContainer/>
											</xforms:group>
										</div>
									</xforms:repeat>
									<xforms:group ref="eac:entityId">
										<div>
											<xforms:input ref=".">
												<xforms:label>Entity Id</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" nodeset="."/>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
										</div>
									</xforms:group>
									<xforms:group ref="eac:descriptiveNote">
										<xeac:descriptiveNote/>
									</xforms:group>
								</div>
								<xxforms:dialog id="import-viaf-dialog" appearance="full" level="modal" close="true" draggable="true" visible="false">
									<xforms:label>Import Data from VIAF</xforms:label>
									<div>
										<xforms:input ref="instance('search-query')">
											<xforms:label>Search</xforms:label>
										</xforms:input>
										<xforms:trigger>
											<xforms:action ev:event="DOMActivate">
												<xforms:send submission="query-viaf"/>
											</xforms:action>
											<xforms:label>Search</xforms:label>
										</xforms:trigger>
									</div>
									<xforms:group ref=".[count(instance('viaf-response')//item) &gt; 0]">
										<xforms:select1 ref="instance('viaf-id')" appearance="compact" id="select-list" xhtml:size="10">
											<xforms:label>Name</xforms:label>
											<xforms:alert>Required</xforms:alert>
											<xforms:itemset nodeset="instance('viaf-response')//item">
												<xforms:label ref="title"/>
												<xforms:value ref="link"/>
											</xforms:itemset>
										</xforms:select1>
										<xforms:trigger>
											<xforms:label>Select</xforms:label>
											<xforms:send ev:event="DOMActivate" submission="get-viaf-rdf"/>
											<xxforms:hide ev:event="DOMActivate" dialog="import-viaf-dialog"/>
										</xforms:trigger>
									</xforms:group>
								</xxforms:dialog>
								<xxforms:dialog id="import-dbpedia-dialog" appearance="full" level="modal" close="true" draggable="true" visible="false">
									<xforms:label>Import Data from DBpedia</xforms:label>
									<div>
										<xforms:input ref="instance('dbpedia-id')">
											<xforms:label>Search</xforms:label>
										</xforms:input>
										<xforms:trigger>
											<xforms:action ev:event="DOMActivate">
												<xforms:send submission="get-dbpedia-rdf"/>
											</xforms:action>
											<xforms:label>Search</xforms:label>
										</xforms:trigger>
									</div>
									<xforms:group ref=".[count(instance('dbpedia-rdf')//rdf:Description) &gt; 0]">
										<xforms:group ref="instance('dbpedia-import')">
											<h3>Select data to import:</h3>
											<div>
												<xforms:input ref="names">
													<xforms:label>Names</xforms:label>
													<xforms:hint>Imports rdfs:label as eac:NameEntry</xforms:hint>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="abstract">
													<xforms:label>Abstract</xforms:label>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="relations">
													<xforms:label>Relations</xforms:label>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="thumbnail">
													<xforms:label>Thumbnail</xforms:label>
												</xforms:input>
											</div>
											<xforms:trigger>
												<xforms:label>Import</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<!-- import names -->
													<xforms:action if="instance('dbpedia-import')/names = 'true'">
														<!-- insert conventionDeclaration -->
														<xforms:insert context="instance('doc')/eac:control" nodeset="./child::node()[last()]" origin="instance('conventionDeclaration-template')"/>
														<xforms:setvalue ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:abbreviation">WIKIPEDIA</xforms:setvalue>
														<xforms:setvalue ref="instance('doc')/eac:control/eac:conventionDeclaration[last()]/eac:citation">Wikipedia/DBpedia</xforms:setvalue>
														<!-- insert nameEntries -->
														<xforms:action xxforms:iterate="instance('dbpedia-rdf')/rdf:Description[1]/descendant::rdfs:label">
															<xxforms:variable name="lang" select="@xml:lang"/>
															<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity" nodeset="./child::node()[last()]"
																origin="instance('nameEntry-template')"/>
															<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:part" value="context()"/>
															<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]" origin="xxforms:attribute('xml:lang', $lang)"/>
															<xforms:action if="$lang = instance('config')/lang">
																<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]" nodeset="./child::node()[last()]"
																	origin="instance('preferredForm-template')"/>
																<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:preferredForm"
																	>WIKIPEDIA</xforms:setvalue>
															</xforms:action>
															<xforms:action if="$lang != instance('config')/lang">
																<xforms:insert context="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]" nodeset="./child::node()[last()]"
																	origin="instance('alternativeForm-template')"/>
																<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:identity/eac:nameEntry[last()]/eac:alternativeForm"
																	>WIKIPEDIA</xforms:setvalue>
															</xforms:action>
														</xforms:action>
													</xforms:action>
													
													<!-- import abstract in xEAC system language (or default english) -->
													<xforms:action if="instance('dbpedia-import')/abstract = 'true'">
														<xxforms:variable name="lang" select="instance('config')/lang"/>
														<xxforms:variable name="comment-lang" select="if (instance('dbpedia-rdf')//rdfs:comment[@xml:lang=$lang]) then $lang else 'en'"/>
														
														<xforms:insert context="instance('doc')/eac:cpfDescription" nodeset="./child::node()[last()]" origin="instance('description-template')" if="not(instance('doc')/eac:cpfDescription/eac:description)"/>
														<xforms:insert context="instance('doc')/eac:cpfDescription/eac:description" origin="instance('biogHist-template')" if="not(instance('doc')/eac:cpfDescription/eac:description/eac:biogHist)"/>
														<xforms:insert context="instance('doc')/eac:cpfDescription/eac:description/eac:biogHist" origin="instance('abstract-template')" if="not(instance('doc')/eac:cpfDescription/eac:description/eac:biogHist/eac:abstract)"/>
														
														<xforms:setvalue ref="instance('doc')/eac:cpfDescription/eac:description/eac:biogHist/eac:abstract" value="instance('dbpedia-rdf')//rdfs:comment[@xml:lang=$comment-lang]"/>
														<xforms:insert context="instance('doc')/eac:cpfDescription/eac:description/eac:biogHist/eac:abstract" origin="xxforms:attribute('xml:lang', $comment-lang)"/>
													</xforms:action>
													<!-- finally, hide dialog -->
													<xxforms:hide ev:event="DOMActivate" dialog="import-dbpedia-dialog"/>
												</xforms:action>
											</xforms:trigger>
										</xforms:group>
									</xforms:group>
								</xxforms:dialog>
							</fr:tab>
							<!--**************************************** DESCRIPTION **********************************-->
							<fr:tab bind="description-tab">
								<fr:label>Description</fr:label>
								<div class="section">
									<h1>Description</h1>
									<span class="add">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<xhtml:img src="{$display_path}images/add.gif"/>
											</xforms:label>
											<xxforms:show ev:event="DOMActivate" dialog="description-objects"/>
										</xforms:trigger>
									</span>
									<xforms:trigger appearance="minimal">
										<xforms:dispatch target="remove-description" name="fr-show" ev:event="DOMActivate"/>
										<xforms:label>
											<xhtml:img src="{$display_path}images/remove.gif"/>
										</xforms:label>
									</xforms:trigger>
									<xxforms:dialog id="description-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
										<xforms:label>Description Objects</xforms:label>
										<xforms:group ref=".[count(eac:biogHist) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>Biog/Hist</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert context="." origin="instance('biogHist-template')"/>
													<xxforms:hide dialog="description-objects"/>
												</xforms:action>
											</xforms:trigger>
										</xforms:group>
										<xforms:group ref=".[count(eac:existDates) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>Dates of Existence</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert context="." origin="instance('existDates-template')"/>
													<xxforms:hide dialog="description-objects"/>
												</xforms:action>
											</xforms:trigger>
										</xforms:group>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Function</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('function-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Functions</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('functions-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:group ref=".[count(eac:generalContext) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>General Context</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert context="." origin="instance('generalContext-template')"/>
													<xxforms:hide dialog="description-objects"/>
												</xforms:action>
											</xforms:trigger>
										</xforms:group>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Language Used</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('languageUsed-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Languages Used</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('languagesUsed-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Legal Status</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('legalStatus-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Legal Statuses</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('legalStatuses-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Local Description</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('localDescription-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Local Descriptions</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('localDescriptions-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Mandate</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('mandate-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Mandates</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('mandates-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Occupation</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('occupation-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Occupations</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('occupations-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Place</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('place-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Places</xforms:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:insert context="." origin="instance('places-template')"/>
												<xxforms:hide dialog="description-objects"/>
											</xforms:action>
										</xforms:trigger>
										<xforms:group ref=".[count(eac:structureOrGenealogy) = 0]">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<img src="{$display_path}images/add.gif"/>Structure or Genealogy</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert context="." origin="instance('structureOrGenealogy-template')"/>
													<xxforms:hide dialog="description-objects"/>
												</xforms:action>
											</xforms:trigger>
										</xforms:group>
									</xxforms:dialog>
									<!-- description elements -->
									<xforms:group ref="eac:biogHist">
										<div class="section">
											<h3>Biographical or Historical Note</h3>
											<span class="add">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<xhtml:img src="{$display_path}images/add.gif"/>
													</xforms:label>
													<xxforms:show ev:event="DOMActivate" dialog="biogHist-objects"/>
												</xforms:trigger>
											</span>
											<xforms:trigger appearance="minimal">
												<xforms:delete nodeset="." ev:event="DOMActivate"/>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
											<xxforms:dialog id="biogHist-objects" appearance="full" level="modal" close="true" draggable="true" visible="false">
												<xforms:label>Add Elements</xforms:label>
												<xforms:group ref=".[count(eac:abstract) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Abstract</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('abstract-template')"/>
															<xxforms:hide dialog="biogHist-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(eac:chronList) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Chronological List</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('chronList-template')"/>
															<xxforms:hide dialog="biogHist-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(eac:citation) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Citation</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('citation-template')"/>
															<xxforms:hide dialog="biogHist-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(eac:list) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>List</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('list-template')"/>
															<xxforms:hide dialog="biogHist-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:group ref=".[count(eac:outline) = 0]">
													<xforms:trigger appearance="minimal">
														<xforms:label>
															<img src="{$display_path}images/add.gif"/>Outline</xforms:label>
														<xforms:action ev:event="DOMActivate">
															<xforms:insert context="." origin="instance('outline-template')"/>
															<xxforms:hide dialog="biogHist-objects"/>
														</xforms:action>
													</xforms:trigger>
												</xforms:group>
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<img src="{$display_path}images/add.gif"/>Paragraph</xforms:label>
													<xforms:action ev:event="DOMActivate">
														<xforms:insert context="." nodeset="./child::node()[last()]" origin="instance('p-template')"/>
														<xxforms:hide dialog="biogHist-objects"/>
													</xforms:action>
												</xforms:trigger>
											</xxforms:dialog>
										</div>
										<xforms:group ref="eac:abstract">
											<div><xforms:textarea ref=".">
													<xforms:label>Abstract</xforms:label>
												</xforms:textarea>
												<xforms:trigger appearance="minimal">
													<xforms:delete ev:event="DOMActivate" nodeset="."/>
													<xforms:label>
														<xhtml:img src="{$display_path}images/remove.gif"/>
													</xforms:label>
												</xforms:trigger></div>
										</xforms:group>
										<xforms:group ref="eac:chronList">
											<xeac:chronList/>
										</xforms:group>
										<xforms:group ref="eac:citation">
											<xeac:citation/>
										</xforms:group>
										<xforms:group ref="eac:list">
											<xeac:list/>
										</xforms:group>
										<xforms:group ref="eac:outline">
											<xeac:outline/>
										</xforms:group>
										<xforms:repeat nodeset="eac:p">
											<xeac:p/>
										</xforms:repeat>
									</xforms:group>
									<xforms:group ref="eac:existDates">
										<xeac:datesContainer/>
									</xforms:group>
									<xforms:repeat nodeset="eac:function">
										<xeac:descriptionTerm/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:functions">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:languageUsed">
										<xeac:languageUsed/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:languagesUsed">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:legalStatus">
										<xeac:descriptionTerm/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:legalStatuses">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:localDescription">
										<xeac:descriptionTerm/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:localDescriptions">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:mandate">
										<xeac:descriptionTerm/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:mandates">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:occupation">
										<xeac:descriptionTerm/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:occupations">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:place">
										<xeac:place/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:places">
										<xeac:descriptionTermGroup/>
									</xforms:repeat>
									<xforms:repeat nodeset="eac:structureOrGenealogy">
										<xeac:structureOrGenealogy/>
									</xforms:repeat>
									<!-- alert for removal of description -->
									<fr:alert-dialog id="remove-description">
										<fr:label>Remove Description</fr:label>
										<fr:message>Are you sure you want to remove the Description section?</fr:message>
										<fr:negative-choice>
											<fr:label>No</fr:label>
										</fr:negative-choice>
										<fr:positive-choice>
											<fr:label>Yes</fr:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:delete nodeset="."/>
												<xforms:dispatch targetid="default-tab" name="fr-toggle"/>
											</xforms:action>
										</fr:positive-choice>
									</fr:alert-dialog>
								</div>
							</fr:tab>
							<!--**************************************** RELATIONS **********************************-->
							<fr:tab bind="relations-tab" id="temp-tab">
								<fr:label>Relations</fr:label>
								<div class="section">
									<h1>Relations</h1>
									<xforms:trigger appearance="minimal">
										<xforms:dispatch target="remove-relations" name="fr-show" ev:event="DOMActivate"/>
										<xforms:label>
											<xhtml:img src="{$display_path}images/remove.gif"/>
										</xforms:label>
									</xforms:trigger>
									<fr:alert-dialog id="remove-relations">
										<fr:label>Remove Relations</fr:label>
										<fr:message>Are you sure you want to remove the Relations section?</fr:message>
										<fr:negative-choice>
											<fr:label>No</fr:label>
										</fr:negative-choice>
										<fr:positive-choice>
											<fr:label>Yes</fr:label>
											<xforms:action ev:event="DOMActivate">
												<xforms:delete nodeset="."/>
												<xforms:dispatch targetid="default-tab" name="fr-toggle"/>
											</xforms:action>
										</fr:positive-choice>
									</fr:alert-dialog>
									<div class="trigger_container">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>CPF Relation</xforms:label>
											<xforms:insert ev:event="DOMActivate" context="." nodeset="./child::node()[last()]" origin="instance('cpfRelation-template')"/>
										</xforms:trigger>
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<img src="{$display_path}images/add.gif"/>Resource Relation</xforms:label>
											<xforms:insert ev:event="DOMActivate" context="." nodeset="./child::node()[last()]" origin="instance('resourceRelation-template')"/>
										</xforms:trigger>
									</div>
									<xforms:group ref=".[count(eac:cpfRelation) &gt; 0]">
										<div class="subsection">
											<h2>CPF Relations</h2>
											<xforms:repeat nodeset="eac:cpfRelation">
												<xeac:cpfRelation/>
											</xforms:repeat>
										</div>
									</xforms:group>
									<xforms:group ref=".[count(eac:resourceRelation) &gt; 0]">
										<div class="subsection">
											<h2>Resource Relations</h2>
											<xforms:repeat nodeset="eac:resourceRelation">
												<xeac:resourceRelation/>
											</xforms:repeat>
										</div>
									</xforms:group>
								</div>
							</fr:tab>
							<!--**************************************** CONTROL **********************************-->
							<fr:tab bind="control-tab">
								<fr:label>Control</fr:label>
								<h1>Control</h1>
								<div>
									<xforms:select1 ref="eac:maintenanceAgency/eac:agencyName">
										<xforms:label>Agency Name</xforms:label>
										<xforms:alert>Required</xforms:alert>
										<xforms:item>
											<xforms:label>Select...</xforms:label>
											<xforms:value/>
										</xforms:item>
										<xforms:itemset nodeset="instance('config')/instances/agencyName-list/item">
											<xforms:label ref="."/>
											<xforms:value ref="."/>
										</xforms:itemset>
									</xforms:select1>
								</div>
								<div>
									<xforms:select1 ref="eac:maintenanceStatus">
										<xforms:label>Maintenance Status</xforms:label>
										<xforms:alert>Required</xforms:alert>
										<xforms:item>
											<xforms:label>Select...</xforms:label>
											<xforms:value/>
										</xforms:item>
										<xforms:itemset nodeset="instance('maintenanceStatus-list')/item">
											<xforms:label ref="."/>
											<xforms:value ref="."/>
										</xforms:itemset>
									</xforms:select1>
								</div>
								<xforms:group ref="eac:maintenanceHistory">
									<div class="section">
										<h2>Maintenance History</h2>
										<div class="trigger_container">
											<xforms:trigger appearance="minimal">
												<xforms:label>
													<xhtml:img src="{$display_path}images/add.gif"/>Maintenance Event</xforms:label>
												<xforms:action ev:event="DOMActivate">
													<xforms:insert context="." origin="instance('maintenanceEvent-template')" nodeset="./child::node()[last()]"/>
												</xforms:action>
											</xforms:trigger>
										</div>
										<xforms:repeat nodeset="eac:maintenanceEvent">
											<div class="subsection">
												<h3>Maintenance Event</h3>
												<div class="trigger_container">
													<xforms:group ref=".[count(eac:eventDescription) = 0]">
														<xforms:trigger appearance="minimal">
															<xforms:label>
																<xhtml:img src="{$display_path}images/add.gif"/>Event Description</xforms:label>
															<xforms:insert ev:event="DOMActivate" context="." origin="instance('eventDescription-template')" nodeset="./child::node()[last()]"/>
														</xforms:trigger>
													</xforms:group>
												</div>
												<div>
													<xforms:select1 ref="eac:eventType">
														<xforms:label>Event Type</xforms:label>
														<xforms:alert>Required</xforms:alert>
														<xforms:item>
															<xforms:label>Select...</xforms:label>
															<xforms:value/>
														</xforms:item>
														<xforms:itemset nodeset="instance('eventType-list')/item">
															<xforms:label ref="."/>
															<xforms:value ref="."/>
														</xforms:itemset>
													</xforms:select1>
												</div>
												<div>
													<xforms:input ref="eac:eventDateTime/@standardDateTime">
														<xforms:label>Event Date/Time</xforms:label>
														<xforms:alert>Required</xforms:alert>
													</xforms:input>
												</div>
												<div>
													<xforms:select1 ref="eac:agentType">
														<xforms:label>Agent Type</xforms:label>
														<xforms:alert>Required</xforms:alert>
														<xforms:item>
															<xforms:label>Select...</xforms:label>
															<xforms:value/>
														</xforms:item>
														<xforms:itemset nodeset="instance('agentType-list')/item">
															<xforms:label ref="."/>
															<xforms:value ref="."/>
														</xforms:itemset>
													</xforms:select1>
												</div>
												<div>
													<xforms:input ref="eac:agent">
														<xforms:label>Agent</xforms:label>
														<xforms:alert>Required</xforms:alert>
													</xforms:input>
												</div>
												<xforms:group ref="eac:eventDescription">
													<div>
														<xforms:input ref=".">
															<xforms:label>Event Description</xforms:label>
														</xforms:input>
														<xforms:trigger appearance="minimal">
															<xforms:delete ev:event="DOMActivate" nodeset="."/>
															<xforms:label>
																<xhtml:img src="{$display_path}images/remove.gif"/>
															</xforms:label>
														</xforms:trigger>
													</div>
												</xforms:group>
											</div>
										</xforms:repeat>
									</div>
								</xforms:group>
								<!-- conventionDeclaration -->
								<div class="section">
									<h2>Convention Declarations</h2>
									<div class="trigger_container">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<xhtml:img src="{$display_path}images/add.gif"/>Convention Declaration</xforms:label>
											<xforms:insert ev:event="DOMActivate" context="." origin="instance('conventionDeclaration-template')" nodeset="./child::node()[last()]"/>
										</xforms:trigger>
									</div>
									<xforms:repeat nodeset="eac:conventionDeclaration">
										<xxforms:variable name="position" select="position()"/>
										<div class="subsection">
											<h3>Declaration</h3>
											<xforms:trigger appearance="minimal">
												<xforms:action ev:event="DOMActivate">
													<xforms:setvalue ref="instance('control-instance')/pos" value="$position"/>
													<xforms:dispatch target="remove-conventionDeclaration" name="fr-show"/>
												</xforms:action>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
											<div class="trigger_container">
												<xforms:trigger appearance="minimal">
													<xforms:label>
														<xhtml:img src="{$display_path}images/add.gif"/>Descriptive Note</xforms:label>
													<xforms:insert ev:event="DOMActivate" context="." origin="instance('descriptiveNote-template')" nodeset="./child::node()[last()]"/>
												</xforms:trigger>
											</div>
											<div>
												<xforms:input ref="eac:abbreviation">
													<xforms:label>Abbreviation</xforms:label>
													<xforms:alert>Required</xforms:alert>
												</xforms:input>
											</div>
											<div>
												<xforms:input ref="eac:citation">
													<xforms:label>Citation</xforms:label>
													<xforms:alert>Required</xforms:alert>
												</xforms:input>
											</div>
											<xforms:group ref="eac:descriptiveNote">
												<xeac:descriptiveNote/>
											</xforms:group>
										</div>
									</xforms:repeat>
								</div>
								<!-- sources -->
								<xforms:group ref="eac:sources">
									<div class="section">
										<h2>Sources</h2>
									</div>
								</xforms:group>
								<!-- alert for removal of conventionDeclaration -->
								<fr:alert-dialog id="remove-conventionDeclaration">
									<fr:label>Remove Convention Declaration</fr:label>
									<fr:message>Are you sure you want to remove this Convention Declaration?</fr:message>
									<fr:negative-choice>
										<fr:label>No</fr:label>
									</fr:negative-choice>
									<fr:positive-choice>
										<fr:label>Yes</fr:label>
										<xforms:action ev:event="DOMActivate">
											<xxforms:variable name="auth" select="eac:conventionDeclaration[position() = instance('control-instance')/pos]/eac:abbreviation"/>
											<!-- blank the values for all nameEntry forms which are equal to the convention declaration abbreviation -->
											<xforms:action xxforms:iterate="instance('doc')//eac:nameEntry[*[. = $auth]]">
												<xforms:setvalue ref="context()/*[contains(local-name(), 'Form')]"/>
											</xforms:action>
											<!-- remove node -->
											<xforms:delete nodeset="eac:conventionDeclaration[position() = instance('control-instance')/pos]"/>
										</xforms:action>
									</fr:positive-choice>
								</fr:alert-dialog>
							</fr:tab>
							<!--**************************************** END CONTROL **********************************-->
							<fr:tab id="preview">
								<fr:label>XML Preview</fr:label>
								<h1>XML Preview</h1>
								<fr:xforms-inspector id="orbeon-xforms-inspector"/>
							</fr:tab>
						</fr:tabview>
					</div>
				</div>
			</div>
			<!-- footer -->
			<!--<xi:include href="xslt/footer.xml"/>-->
		</div>
	</xhtml:body>
</xhtml:html>
